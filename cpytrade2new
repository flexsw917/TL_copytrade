import requests
import time

# Your existing functions remain unchanged

def get_instruments(account_id, access_token):
    url = f"https://api.tradelocker.com/trade/accounts/{account_id}/instruments"
    headers = {
        "Authorization": f"Bearer {access_token}"
    }
    
    response = requests.get(url, headers=headers)
    if response.status_code == 200:
        instruments = response.json()
        return instruments
    else:
        raise Exception(f"Failed to retrieve instruments with status code {response.status_code}")

def monitor_and_replicate_trades(master_acc_id, slave_acc_ids, master_access_token, slave_access_tokens):
    while True: # Continuously monitor the master account
        try:
            master_positions = get_open_positions(master_acc_id, master_access_token)
            master_instruments = get_instruments(master_acc_id, master_access_token)
            
            for slave_acc_id, slave_access_token in zip(slave_acc_ids, slave_access_tokens):
                for position in master_positions:
                    # Find the corresponding instrument for the position
                    instrument = next((inst for inst in master_instruments if inst["instrumentId"] == position["instrumentId"]), None)
                    if instrument:
                        order_details = {
                            "instrumentId": position["instrumentId"],
                            "orderType": position["type"],
                            "quantity": position["quantity"],
                            "price": position["price"],
                            "routeId": instrument["tradeRouteId"] # Use the TRADE routeId
                        }
                        
                        try:
                            place_order(slave_acc_id, slave_access_token, order_details)
                            print(f"Order replicated for slave account {slave_acc_id}: {order_details}")
                        except Exception as e:
                            print(f"Failed to place order on slave account {slave_acc_id}: {str(e)}")
                    else:
                        print(f"Instrument not found for position {position}")
            
            time.sleep(2) # Wait for 2 seconds before checking again
        except Exception as e:
            print(f"Error during monitoring: {str(e)}")
            time.sleep(2) # Wait for 2 seconds before retrying

# Your existing main function remains unchanged

main()
